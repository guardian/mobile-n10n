AWSTemplateFormatVersion: '2010-09-09'
Description: Reporting for mobile notifications
Mappings:
 # Static values could be inlined. GuCDK will do this.
 Constants:
    App:
      Value: report
    Stack:
      Value: mobile-notifications

 # These values do not vary by stage, so could be inlined.
 StageVariables:
    CODE:
      NotificationAlarmPeriod: 1200
      ScalingUpPeriod: 300
      ScalingUpThreshold: 20
      ScalingDownPeriod: 300
      ScalingDownThreshold: 15
      InstanceType: "t4g.micro"
    PROD:
      NotificationAlarmPeriod: 1200
      ScalingUpPeriod: 300
      ScalingUpThreshold: 20
      ScalingDownPeriod: 300
      ScalingDownThreshold: 15
      InstanceType: "t4g.micro"
Outputs:
  LoadBalancerUrl:
    Value:
      !GetAtt LoadBalancerToPrivateASG.DNSName
Parameters:
  AMI:
    Description: AMI used by the instances,
    Type: AWS::EC2::Image::Id
  Stage:
    Type: String
    AllowedValues:
    - CODE
    - PROD
    Description: Environment name

  # TODO remove as not working as it implies
  VPCSecurityGroup:
    Type: AWS::EC2::SecurityGroup::Id
    Description: The default security group of the VPC

  VpcId:
    Type: AWS::EC2::VPC::Id
    Description: The VPC
  PublicSubnets:
    Type: List<AWS::EC2::Subnet::Id>
    Description: The public subnets of the VPC for the loadbalancer
  PrivateSubnets:
    Type: List<AWS::EC2::Subnet::Id>
    Description: The private subnets of the VPC for the autoscaling group

  # Could be inlined. GuCDK will do this.
  ASGMinSize:
    Type: Number
    Description: Minimum size of the autoscaling group
  # Could be inlined. GuCDK will do this.
  ASGMaxSize:
    Type: Number
    Description: Maximum size of the autoscaling group

  # TODO read from SSM Parameters. GuCDK will do this.
  DistBucket:
    Type: String
    Description: The name of the s3 bucket containing the server artifact

  # TODO provision this certificate within this stack
  AppCertArn:
    Type: String
    Description: ACM Certificate for app use

  # TODO Stage aware value could be moved to StageVariables. GuCDK will simplify this.
  HostedZone:
    Type: String
    Description:  The HostedZone, should contain the trailing dot zone.example.com.

  # TODO Stage aware value could be moved to StageVariables. GuCDK will simplify this.
  DomainName:
    Type: String
    Description: The domain name of the ELB, should contain the trailing dot stuff.zone.example.com.

Resources:
  DnsRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      HostedZoneName: !Ref HostedZone
      Name: !Ref DomainName
      ResourceRecords:
      - !GetAtt LoadBalancerToPrivateASG.DNSName
      TTL: 60
      Type: CNAME

  # Ophan is the only consumer of this service, does it make so many requests that we have to horizontally scale?
  # The ASG does not have metrics enabled, so cannot see scaling activity.
  # Alarm history is kept for 30 days - it hasn't fired.
  # TODO check with MSS and remove
  HighCpuAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions: [!Ref ScaleUpPolicy]
      AlarmDescription: !Sub
      - Scale-Up if cpu is greater than ${Threshold}% over last ${Period} seconds
      - Threshold: !FindInMap [ StageVariables, !Ref Stage, ScalingUpThreshold ]
        Period: !FindInMap [ StageVariables, !Ref Stage, ScalingUpPeriod ]
      ComparisonOperator: GreaterThanOrEqualToThreshold
      Dimensions:
      - Name: AutoScalingGroupName
        Value: !Ref PrivateReportAutoscalingGroup
      EvaluationPeriods: 1
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Period: !FindInMap [ StageVariables, !Ref Stage, ScalingUpPeriod ]
      Statistic: Average
      Threshold: !FindInMap [ StageVariables, !Ref Stage, ScalingUpThreshold ]

  # Ophan is the only consumer of this service, does it make so many requests that we have to horizontally scale?
  # The ASG does not have metrics enabled, so cannot see scaling activity.
  # Alarm history is kept for 30 days - it hasn't fired.
  LowCpuAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmActions: [!Ref ScaleDownPolicy]
      AlarmDescription: !Sub
      - Scale-Down if cpu is lower than ${Threshold}% over last ${Period} seconds
      - Threshold: !FindInMap [ StageVariables, !Ref Stage, ScalingDownThreshold ]
        Period: !FindInMap [ StageVariables, !Ref Stage, ScalingDownPeriod ]
      ComparisonOperator: LessThanThreshold
      Dimensions:
      - Name: AutoScalingGroupName
        Value: !Ref PrivateReportAutoscalingGroup
      EvaluationPeriods: 1
      MetricName: CPUUtilization
      Namespace: AWS/EC2
      Period: !FindInMap [ StageVariables, !Ref Stage, ScalingDownPeriod ]
      Statistic: Average
      Threshold: !FindInMap [ StageVariables, !Ref Stage, ScalingDownThreshold ]

  InstanceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Open up HTTP access to load balancer
      SecurityGroupEgress:
      - CidrIp: 0.0.0.0/0
        FromPort: 80
        IpProtocol: tcp
        ToPort: 80
      - CidrIp: 0.0.0.0/0
        FromPort: 443
        IpProtocol: tcp
        ToPort: 443
      SecurityGroupIngress:
      - FromPort: 9000
        IpProtocol: tcp
        SourceSecurityGroupId: !Ref LoadBalancerSecurityGroup
        ToPort: 9000
      VpcId: !Ref VpcId

  LoadBalancerToPrivateASG:
    Type: AWS::ElasticLoadBalancing::LoadBalancer
    Properties:
      CrossZone: true
      HealthCheck:
        HealthyThreshold: 2
        Interval: 30
        Target: HTTP:9000/healthcheck
        Timeout: 10
        UnhealthyThreshold: 10
      Listeners:
      - InstancePort: 9000
        LoadBalancerPort: 443
        Protocol: HTTPS
        SSLCertificateId: !Ref AppCertArn
      SecurityGroups:
      - !Ref LoadBalancerSecurityGroup
      Subnets: !Ref PublicSubnets
  LoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Open up HTTP access to load balancer

      # TODO
      #  - restrict this to the ASG?
      #  - Check what egress rules CDK would add to the load balancer
      SecurityGroupEgress:
      - CidrIp: 0.0.0.0/0
        FromPort: 9000
        IpProtocol: tcp
        ToPort: 9000

      SecurityGroupIngress:
      - CidrIp: 0.0.0.0/0
        FromPort: 443
        IpProtocol: tcp
        ToPort: 443
      VpcId: !Ref VpcId

  NotificationsReportInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Path: /
      Roles:
      - !Ref NotificationsReportRole
  NotificationsReportRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Action:
            - sts:AssumeRole
          Effect: Allow
          Principal:
            Service:
              - ec2.amazonaws.com
      Path: /
      ManagedPolicyArns: [ !Sub 'arn:aws:iam::${AWS::AccountId}:policy/ssm-scala-v1' ]
      Policies:
      - PolicyName: root
        PolicyDocument:
          Statement:
          # To download the application artifact. GuCDK will tightly scope this.
          - Action: s3:GetObject
            Effect: Allow
            Resource: !Sub arn:aws:s3:::${DistBucket}/*

          - Action: ec2:DescribeTags
            Effect: Allow
            Resource: '*'

          # TODO work out how these permissions are used by the application
          - Action:
            - cloudwatch:*
            - logs:*
            Effect: Allow
            Resource: '*'

          - Action:
              - autoscaling:DescribeAutoScalingInstances
              - autoscaling:DescribeAutoScalingGroups
            Resource: '*'
            Effect: Allow

          # To ship logs to Central ELK
          - Effect: Allow
            Action:
            - kinesis:PutRecord
            - kinesis:PutRecords
            - kinesis:DescribeStream
            Resource: !Sub arn:aws:kinesis:${AWS::Region}:${AWS::AccountId}:stream/mobile-log-aggregation-${Stage}
      - PolicyName: dynamo
        PolicyDocument:
          Statement:
          - Action: dynamodb:* # TODO tightly scope this (it allows for deletion ðŸ˜±)
            Effect: Allow
            Resource:
            - !Sub arn:aws:dynamodb:eu-west-1:${AWS::AccountId}:table/mobile-notifications-reports-${Stage}
            - !Sub arn:aws:dynamodb:eu-west-1:${AWS::AccountId}:table/mobile-notifications-reports-${Stage}/index/*

      # To read config from SSM
      - PolicyName: conf
        PolicyDocument:
          Statement:
          - Action: ssm:GetParametersByPath
            Effect: Allow
            Resource:
              !Sub
                - arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/notifications/${Stage}/${Stack}
                - Stack: !FindInMap [Constants, Stack, Value]

  PrivateReportAutoscalingGroup:
    Type: AWS::AutoScaling::AutoScalingGroup
    Properties:
      AvailabilityZones: !GetAZs
      HealthCheckGracePeriod: 400
      HealthCheckType: ELB
      LaunchConfigurationName: !Ref ReportLaunchConfig
      LoadBalancerNames:
      - !Ref LoadBalancerToPrivateASG
      MaxSize: !Ref ASGMaxSize
      MinSize: !Ref ASGMinSize

      # These currently go to the MSS team. GuCDK doesn't add this by default.
      # TODO check if the MSS team use the notifications. If they don't, remove this bit?
      NotificationConfiguration:
        NotificationTypes:
        - autoscaling:EC2_INSTANCE_LAUNCH_ERROR
        - autoscaling:EC2_INSTANCE_TERMINATE_ERROR
        TopicARN: !Sub arn:aws:sns:eu-west-1:${AWS::AccountId}:AutoscalingNotifications${Stage}

      Tags:
      - Key: Stage
        PropagateAtLaunch: true
        Value: !Ref Stage
      - Key: Stack
        PropagateAtLaunch: true
        Value: !FindInMap [Constants, Stack, Value]
      - Key: App
        PropagateAtLaunch: true
        Value: !FindInMap [Constants, App, Value]
      VPCZoneIdentifier: !Ref PrivateSubnets
  ReportLaunchConfig:
    Type: AWS::AutoScaling::LaunchConfiguration
    Properties:
      AssociatePublicIpAddress: false
      IamInstanceProfile: !Ref NotificationsReportInstanceProfile
      ImageId: !Ref AMI
      InstanceType: !FindInMap [StageVariables, !Ref Stage, InstanceType]
      SecurityGroups:
      - !Ref InstanceSecurityGroup

      # TODO remove this
      - !Ref VPCSecurityGroup
      MetadataOptions:
        HttpTokens: required
      UserData:

        # TODO replace configure-aws-kinesis-agent with devx-logs?
        # Log stream is stage aware.
        Fn::Base64:
           !Sub
            - |
                #!/bin/bash -ev
                aws --region ${AWS::Region} s3 cp s3://${DistBucket}/${Stack}/${Stage}/${App}/${App}_1.0-latest_all.deb /tmp
                dpkg -i /tmp/${App}_1.0-latest_all.deb
                /opt/aws-kinesis-agent/configure-aws-kinesis-agent ${AWS::Region} mobile-log-aggregation-${Stage} /var/log/${App}/application.log
            - Stack: !FindInMap [Constants, Stack, Value]
              App: !FindInMap [Constants, App, Value]

  # If we remove the AWS::CloudWatch::Alarm resources above, these can also be removed.
  # TODO check with MSS and remove?
  ScaleDownPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: ChangeInCapacity
      AutoScalingGroupName: !Ref PrivateReportAutoscalingGroup
      Cooldown: 3600
      ScalingAdjustment: -1

  # If we remove the AWS::CloudWatch::Alarm resources above, these can also be removed.
  # TODO check with MSS and remove?
  ScaleUpPolicy:
    Type: AWS::AutoScaling::ScalingPolicy
    Properties:
      AdjustmentType: PercentChangeInCapacity
      AutoScalingGroupName: !Ref PrivateReportAutoscalingGroup
      Cooldown: 300
      ScalingAdjustment: 100

